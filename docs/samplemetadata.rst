Adding Sample Metadata
----------------------

Additional study design parameters or sample metadata may be mapped into the Dataset using the addSampleInfo() method. For the purpose of standardising QC filtering procedures, the nPYc toolbox defines a small set of terms for describing reference sample types and design elements.


Sample and study design nomenclature
====================================

The :mod:`nPYc` toolbox uses the following nomenclature when defining sample types and analytical study design elements. Certain terms are defined and controlled in the :mod:`~nPYc.enumerations` module.

.. figure:: _static/samplingNomenclature.svg
	:width: 70%
	:align: center
	:alt: Generation of samples
	
	Generation of samples
	 
The hierarchy of sample generation, :term:`Study samples<study sample>` are generated from :term:`participants<participant>` at one or more :term:`sampling events<sampling event>`. These sample are then :term:`assayed<assay>` by one or more methods, generating a :term:`unique<Sample Base Name>` dataset for each :term:`sample assay`.
	
In order to estimate analytical quality in a robust and extensible fashion, the nPYc-Toolbox characterises the samples constituting a study by two parameters; the sample type, i.e., the source and composition of the sample, and the assay role, the rational for a specific acquisition of data.
	
The most common Sample Types are:

- Study Samples comprise the study in question
- A Study Pool consists of a mixture of all study samples
- An External Reference is a sample of a comparable matrix to the Study Samples, but not a sample (or mixture) derived from samples acquired as part of the study
- A Method Reference mixture consists of a synthetic mixture of known chemical standards
- A Procedural Blank is handled identically to the Study Samples, but is not expected to contain any signals from the sample matrix
	
While the following Assay Roles are defined:

- Assays form the core of an analysis
- Precision Reference assays that are repeatedly acquired, and used to calculate measures of analytical precision
- Linearity Reference assays that are used to assess the linearity of response in the dataset, often by repeated injection at varying concentrations or levels of dilution. If generated by dilution from a base level, the percentage concentration of each Linearity Reference sample is indicated in the ’Dilution’ field of the sampleMetadata table

In brief, precision reference assays are acquired to characterise analytical variability, while linearity reference assays provide a measure of a samples response to changes in abundance. These measurements may be made on synthetic reference mixtures, repeatedly measured samples of a representative matrix, or a pool of the samples in the study.
	
Common samples used in QC of profiling studies include:

- 'Study Reference (SR)': A study pool and precision reference represents the classic pooled QC sample used in profiling studies to asses analytical stability
- 'Linearity Reference (LTR)': A study pool and linearity reference represents the use of the same pooled sample to asses the response of of each feature to changing sample composition
	

CSV template for metadata import
================================

The ‘Basic CSV’ format specifies a simple method for matching analytical data to metadata. Although optional, it is recommend to generate such a CSV file containing basic metadata about each of the imported spectra. 

The nPYc-Toolbox options contains a default syntax for adding sample metadata in a predefined CSV format.

In brief, this CSV file format expects information to be provided for 6 pre-defined column names, ‘Sample File Name’, ‘Sample ID’, ‘SampleType’, ‘AssayRole’, ‘Dilution’, ‘Include Sample’. Any extra metadata (such as patient characteristics or clinical metadata) can be placed in this file, as long as the column names are not in the list of expected fields.

The 'Basic CSV' file matches based on the entries in the 'Sample File Name' column to the 'Sample File Name' in the :py:attr:`~nPYc.objects.Dataset.sampleMetadata` table. :term:`Sample types<sample type>` and :term:`assay roles<assay role>` can be described using the values defined in the :py:mod:`~nPYc.enumerations` module (and above). Where 'Include Sample' is ``False``, the :py:attr:`~nPYc.objects.Dataset.sampleMask` for that sample will be set to ``False``. By default samples that cannot be matched to entries in the basic ; file are also masked.

.. table:: Minimal structure of a basic csv file
   :widths: auto
   
   =========== ============================== =================== ================== ======== ==============
   Sampling ID Sample File Name               AssayRole           SampleType         Dilution Include Sample
   =========== ============================== =================== ================== ======== ==============
   Dilution 1  UnitTest1_LPOS_ToF02_B1SRD01   Linearity Reference Study Pool         1        TRUE
   Dilution 2  UnitTest1_LPOS_ToF02_B1SRD02   Linearity Reference Study Pool         50       TRUE
   Sample 1    UnitTest1_LPOS_ToF02_S1W07     Assay               Study Sample       100      TRUE
   Sample 2    UnitTest1_LPOS_ToF02_S1W08_x   Assay               Study Sample       100      TRUE
   LTR         UnitTest1_LPOS_ToF02_S1W11_LTR Precision Reference External Reference 100      TRUE
   SR          UnitTest1_LPOS_ToF02_S1W12_SR  Precision Reference Study Pool         100      TRUE
   Sample 3    UnitTest1_LPOS_ToF02_S1W09_x   Assay               Study Sample       100      FALSE
   Blank 1     UnitTest1_LPOS_ToF02_Blank01   Assay               Procedural Blank   0        TRUE
   =========== ============================== =================== ================== ======== ==============

Any additional columns in the basic csv file will be appended to the :py:attr:`~nPYc.objects.Dataset.sampleMetadata` table as additional sample metadata.

